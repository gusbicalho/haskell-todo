<!doctype html>
<html>
  <head><title>Haskell TODO</title></head>
  <body>
    <h1>TODO</h1>
    <form id="login-form">
      User: <input name="login" type="text" /><br/>
      Password: <input name="password" type="password" /><br/>
      <input type="submit" value="Login!" />
    </form>
    <div>
      <h2>To-dos for user <span id="user-login"></span> </h2>
      <ul id="todos"></ul>
    </div>

    <script>
      let loginForm = document.querySelector("#login-form")
      loginForm.onsubmit = onSubmit

      class Store {
        constructor(val, watch) {
          this._val = val
          this._watch = watch
        }
        async update(transform) {
          this._val = await transform(this._val)
          await this._watch(this._val)
          return this._val
        }

        async get() {
          return await this.update(u => u)
        }
      }

      let userStore = new Store(null, user => {
        whenLet(user.login, login => {
          document.querySelector("#user-login").innerHTML = login
        })
        whenLet(user.items, items => {
          const todos = document.querySelector("#todos")
          todos.innerHTML = ""
          for (item of items) {
            const li = document.createElement("li")
            li.append(makeItemView(item))
            todos.appendChild(li)
          }
        })
      })

      const updateItemState = (item, div) => () => {
        console.log(item)
      }

      function makeItemView(item) {
        const div = document.createElement("div")
        const stateBtn = document.createElement("button")
        stateBtn.onclick = updateItemState(item, div)
        stateBtn.append(item.state)
        div.appendChild(stateBtn)
        div.append(item.title)
        return div
      }

      function xsrfToken() {
        let r = document.cookie.match(new RegExp('XSRF-TOKEN=([^;]+)'))
        if (r) return r[1];
      }

      function whenLet(x, f) {
        if (!x) return null;
        return x.then ? x.then(x2 => whenLet(x2, f)) : f(x)
      }

      async function authFetch(target, options) {
        options = options || {}
        let headers = options.headers || new Headers()
        await whenLet(xsrfToken(), token => {
          headers.set('X-XSRF-TOKEN', token)
        })
        await whenLet(userStore.get(), user => {
          headers.set('Authorization', 'Bearer ' + user.token)
        })
        return await fetch(target, {
          ...options,
          headers,
          credentials: 'same-origin',
        })
      }

      function onSubmit(event) {
        let loginForm = event.target
        let login = loginForm.login.value
        let password = loginForm.password.value
        let headers = new Headers()
        headers.set('Authorization', 'Basic ' + btoa(login + ":" + password))
        fetch('/api/auth/user', {
          method: 'post',
          headers,
          credentials: 'same-origin',
        }).then((response) =>
          response.status === 200
            ? response.json()
            : { error: response.statusText }
        ).then((result) => {
          if (result.error) {
            alert(result.error)
            return;
          }
          loginSuccessful(result.identity.userId, result.token)
        })
        return false
      }

      async function loginSuccessful(userId, token) {
        let user = await userStore.update(() => ({ id: userId, token }))
        let [userDetail, { items }] = await Promise.all([
          authFetch(`/api/users/${user.id}`).then(resp => resp.json()),
          authFetch(`/api/users/${user.id}/items`).then(resp => resp.json())
        ])
        await userStore.update(user => ({ ... user, ...userDetail.user, items }))

      }
    </script>
  </body>
</html>
