<!doctype html>
<html>
  <head><title>Haskell TODO</title></head>
  <body>
    <h1>TODO</h1>
    <form id="login-form">
      User: <input name="login" type="text" /><br/>
      Password: <input name="password" type="password" /><br/>
      <input type="submit" value="Login!" />
    </form>
    <div>
      <h2>To-dos for user <span id="user-login"></span> </h2>
    </div>

    <script>
      let loginForm = document.querySelector("#login-form")
      loginForm.onsubmit = onSubmit

      let _loggedInUser = null;
      async function updateUser(transform) {
        _loggedInUser = transform(_loggedInUser)
        whenLet(_loggedInUser.login, login => {
          document.querySelector("#user-login").innerHTML = login
        })
        return _loggedInUser
      }
      async function getUser() {
        return await updateUser(u => u);
      }

      function xsrfToken() {
        let r = document.cookie.match(new RegExp('XSRF-TOKEN=([^;]+)'))
        if (r) return r[1];
      }

      function whenLet(x, f) {
        if (!x) return null;
        return x.then ? x.then(x2 => whenLet(x2, f)) : f(x)
      }

      async function authFetch(target, options) {
        options = options || {}
        let headers = options.headers || new Headers()
        await whenLet(xsrfToken(), token => {
          headers.set('X-XSRF-TOKEN', token)
        })
        await whenLet(getUser(), user => {
          headers.set('Authorization', 'Bearer ' + user.token)
        })
        return await fetch(target, {
          ...options,
          headers,
          credentials: 'same-origin',
        })
      }

      function onSubmit(event) {
        console.log(event)
        let loginForm = event.target
        let login = loginForm.login.value
        let password = loginForm.password.value
        let headers = new Headers()
        headers.set('Authorization', 'Basic ' + btoa(login + ":" + password))
        fetch('/api/auth/user', {
          method: 'post',
          headers,
          credentials: 'same-origin',
        }).then((response) =>
          response.status === 200
            ? response.json()
            : { error: response.statusText }
        ).then((result) => {
          if (result.error) {
            alert(result.error)
            return;
          }
          loginSuccessful(result.identity.userId, result.token)
        })
        return false
      }

      async function loginSuccessful(userId, token) {
        let user = await updateUser(() => ({ id: userId, token }))
        let userDetail = await authFetch(`/api/users/${user.id}`).then(resp => resp.json())
        await updateUser(user => ({ ... user, ...userDetail.user }))
        console.log(userDetail)
      }
    </script>
  </body>
</html>
